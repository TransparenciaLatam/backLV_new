<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ tercero.nombre if tercero else 'Formulario' }} - Linking Values</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
   <style>
    /* Estilos completos proporcionados por el usuario para un look & feel idéntico */
    body { background-image: url('/static/HERO PAGE LINKING VALUES.png'); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; background-color: #f6f6ef; color: #333333; font-family: 'Montserrat', Verdana, Geneva, sans-serif; font-size: 10pt; min-height: 100vh; }
    .question-block { border: 1px solid #e0e0e0; padding: 1rem; margin-bottom: 1rem; background-color: rgba(255, 255, 255, 0.95); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .axis-heading { font-size: 1.5rem; font-weight: 700; color: #333; border-left: 4px solid; padding-left: 1rem; margin-top: 2rem; margin-bottom: 1rem; }
    .hn-input, .hn-textarea { border: 1px solid #828282; padding: 8px 10px; border-radius: 4px; width: 100%; transition: border-color 0.2s; background-color: #fff; }
    .hn-input:focus, .hn-textarea:focus { border-color: #ff6600; outline: none; }
    .btn-primary { background-color: #ff6600; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; border: none; transition: background-color 0.2s ease; }
    .btn-primary:hover { background-color: #e65c00; }
    .hidden { display: none; }
    .form-container { background-color: rgba(246, 246, 239, 0.92); padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .message-box { text-align: center; padding: 3rem 1.5rem; }
    .message-box .icon { font-size: 4rem; color: #ff6600; margin-bottom: 1rem; }
    .message-box h2 { font-size: 1.8rem; font-weight: 700; }
    .message-box p { font-size: 1.1rem; color: #555; }
  </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center">

  <div class="container mx-auto max-w-3xl form-container">

    {% if status == 'ready_to_fill' %}
      <h1 class="text-3xl font-bold mb-6 text-center" style="color: #ff6600;">{{ title }}</h1>
      <p class="text-center text-gray-600 mb-8">Bienvenido, {{ tercero.nombre }}. Por favor, complete el siguiente formulario.</p>

      <!--
        LA CORRECCIÓN MÁS IMPORTANTE ESTÁ AQUÍ:
        - El atributo 'action' ahora incluye dinámicamente el ID del tercero.
        - 'enctype' se añade para permitir la subida de archivos.
      -->
      <form id="dynamic-form" action="/submit-form/{{ tercero.id }}" method="POST" enctype="multipart/form-data">
        {% for field in fields %}

          {% if field.type == 'heading' %}
            <h2 class="axis-heading" style="border-color: {{ {'dh': '#4CAF50', 'ma': '#2196F3', 'pl': '#9C27B0', 'ge': '#FFC107'}.get(field.id, '#ff6600') }};">
              {{ field.label }}
            </h2>

          {% elif field.type in ['text', 'date', 'number', 'url'] %}
            <div class="question-block" data-question-id="{{ field.id }}">
              <label for="{{ field.id }}" class="block text-md font-medium mb-2">{{ field.label }}{% if field.required %} <span class="text-red-500">*</span>{% endif %}</label>
              {% if field.helpText %}<p class="text-sm text-gray-500 mb-2">{{ field.helpText }}</p>{% endif %}
              <input type="{{ field.type }}" id="{{ field.id }}" name="{{ field.name }}" class="hn-input" {% if field.required %}required{% endif %}>
            </div>

          {% elif field.type == 'file' %}
             <div class="question-block" data-question-id="{{ field.id }}">
              <label for="{{ field.id }}" class="block text-md font-medium mb-2">{{ field.label }}{% if field.required %} <span class="text-red-500">*</span>{% endif %}</label>
              {% if field.helpText %}<p class="text-sm text-gray-500 mb-2">{{ field.helpText }}</p>{% endif %}
              <input type="file" id="{{ field.id }}" name="{{ field.name }}" class="hn-input" {% if field.required %}required{% endif %}>
            </div>

          {% elif field.type == 'textarea' %}
            <div class="question-block" data-question-id="{{ field.id }}">
              <label for="{{ field.id }}" class="block text-md font-medium mb-2">{{ field.label }}{% if field.required %} <span class="text-red-500">*</span>{% endif %}</label>
              {% if field.helpText %}<p class="text-sm text-gray-500 mb-2">{{ field.helpText }}</p>{% endif %}
              <textarea id="{{ field.id }}" name="{{ field.name }}" rows="4" class="hn-textarea" {% if field.required %}required{% endif %}></textarea>
            </div>

          {% elif field.type == 'radio' or field.type == 'checkbox' %}
            <div class="question-block" data-question-id="{{ field.id }}">
              <fieldset>
                <legend class="text-md font-medium mb-2">{{ field.label }}{% if field.required %} <span class="text-red-500">*</span>{% endif %}</legend>
                {% if field.helpText %}<p class="text-sm text-gray-500 mb-2">{{ field.helpText }}</p>{% endif %}
                <div class="space-y-2">
                  {% for option in field.options %}
                    <div class="flex items-center">
                      <input id="{{ field.id }}-{{ loop.index }}" name="{{ field.name }}" type="{{ field.type }}" value="{{ option.value }}" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                      <label for="{{ field.id }}-{{ loop.index }}" class="ml-3 block text-sm font-medium">{{ option.label }}</label>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
            </div>

          {% elif field.type == 'submit' %}
            <div class="mt-8 text-center">
              <button type="submit" class="btn-primary text-lg">
                {{ field.value }}
              </button>
            </div>
          {% endif %}

        {% endfor %}
      </form>

    {% elif status == 'completed' %}
    <div class="message-box">
      <div class="icon">✅</div>
      <h2>¡Gracias, {{ tercero.nombre }}!</h2>
      <p>Su formulario ha sido enviado con éxito. Hemos recibido su información.</p>

      <div class="next-step">
        <div class="icon">⏳</div>
        <p>Actualmente estamos revisando su solicitud. Una vez que nuestros analistas completen la evaluación, avanzará automáticamente a la siguiente etapa del proceso.</p>
      </div>
    </div>

    {% elif status == 'waiting' %}
      <div class="message-box">
        <div class="icon">⏳</div>
        <h2>Bienvenido, {{ tercero.nombre }}</h2>
        <p>Su formulario aún no ha sido asignado. Por favor, vuelva a intentarlo más tarde o contacte al administrador.</p>
      </div>

    {% else %}
      <div class="message-box">
        <div class="icon">⚠️</div>
        <h2>Error</h2>
        <p>No se pudo cargar el formulario. Por favor, contacte al administrador.</p>
      </div>
    {% endif %}
  </div>

<script>
  // El script de JS para la lógica condicional no necesita cambios.
  document.addEventListener('DOMContentLoaded', function() {
    // Solo ejecuta el script si el formulario existe en la página
    const formElement = document.getElementById('dynamic-form');
    if (!formElement) return;

    const formSchema = {{ fields | tojson }};
    const elements = new Map(Array.from(formElement.querySelectorAll('[data-question-id]')).map(el => [el.dataset.questionId, el]));

    function checkCondition(condition) {
      if (!condition || !condition.parentQuestionId || !condition.expectedValue) return true;

      const parentInputs = formElement.querySelectorAll(`[name="${condition.parentQuestionId}"]`);
      if (parentInputs.length === 0) return false;

      // Manejar radio buttons y checkboxes
      if (parentInputs[0].type === 'radio' || parentInputs[0].type === 'checkbox') {
          const selected = formElement.querySelector(`[name="${condition.parentQuestionId}"]:checked`);
          return selected ? selected.value.toLowerCase() === condition.expectedValue.toLowerCase() : false;
      }

      // Manejar otros inputs (text, textarea, select, etc.)
      return parentInputs[0].value.toLowerCase() === condition.expectedValue.toLowerCase();
    }

    function updateVisibility() {
      formSchema.forEach(field => {
        if (field.condition) {
          const element = elements.get(field.id);
          if (element) {
            if (checkCondition(field.condition)) {
              element.classList.remove('hidden');
            } else {
              element.classList.add('hidden');
            }
          }
        }
      });
    }

    formElement.addEventListener('change', updateVisibility);
    updateVisibility(); // Estado inicial
  });
</script>

</body>
</html>